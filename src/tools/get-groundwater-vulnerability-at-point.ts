import { z } from 'zod';
import { sguClient } from '@/clients/sgu-client';
import { withErrorHandling } from '@/lib/response';
import { validatePoint, CRS_SWEREF99TM } from '@/lib/geometry-utils';

export const getGroundwaterVulnerabilityAtPointInputSchema = {
  x: z.number().describe('X coordinate (Easting in SWEREF99TM, EPSG:3006)'),
  y: z.number().describe('Y coordinate (Northing in SWEREF99TM, EPSG:3006)'),
};

export const getGroundwaterVulnerabilityAtPointTool = {
  name: 'sgu_get_groundwater_vulnerability_at_point',
  description:
    'Get groundwater vulnerability (grundvattnets sÃ¥rbarhet) at a specific coordinate in Sweden. ' +
    'Returns a 3-class vulnerability assessment (low, moderate, high) indicating how susceptible ' +
    'the groundwater is to contamination from surface activities. ' +
    'Coordinates must be in SWEREF99TM (EPSG:3006). ' +
    'Useful for environmental planning and protection zone assessments.',
  inputSchema: getGroundwaterVulnerabilityAtPointInputSchema,
};

type GetGroundwaterVulnerabilityAtPointInput = {
  x: number;
  y: number;
};

export const getGroundwaterVulnerabilityAtPointHandler = withErrorHandling(
  async (args: GetGroundwaterVulnerabilityAtPointInput) => {
    const point = { x: args.x, y: args.y };

    // Validate the point coordinates
    validatePoint(point);

    // Get groundwater vulnerability information
    const vulnerability = await sguClient.getGroundwaterVulnerabilityAt(point);

    return {
      coordinate_system: CRS_SWEREF99TM,
      coordinates: {
        x: args.x,
        y: args.y,
      },
      found: vulnerability !== null,
      groundwater_vulnerability: vulnerability,
    };
  },
);
